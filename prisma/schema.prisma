generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//////////////////////////////////// Authentication Models //////////////////////////////////////////
model User {
  id        String  @id
  name      String
  collageId String?
  email     String  @unique

  totalScore     Int @default(0)
  problemsSolved Int @default(0)

  tags          String[] @default(["student"])
  emailVerified Boolean  @default(false)
  image         String?

  codeChefHandle   String?
  leetCodeHandle   String?
  hackerrankHandle String?
  githubHandle     String?

  role                Role    @default(STUDENT)
  onboardingCompleted Boolean @default(false)
  bio                 String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions    Session[]
  accounts    Account[]
  submissions Submission[]
  problems    Problem[]

  @@index([collageId])
  @@index([collageId, totalScore])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ipAddress String?
  userAgent String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id         String @id
  accountId  String
  providerId String
  userId     String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

////////////////////////////////////// Problem Models ///////////////////////////////////////////

model Problem {
  id          String @id @default(cuid())
  title       String
  description String

  hidden      Boolean       @default(true)
  slug        String        @unique
  score       Int
  solved      Int?          @default(0)
  difficulty  Difficulty    @default(EASY)
  type        ProblemType   @default(PRACTICE)
  domain      ProblemDomain @default(DSA)
  hiddenQuery String?

  useFunctionTemplate Boolean @default(false)
  solution            String? @db.Text

  submissions       Submission[]
  testCases         ProblemTestCase[]
  categoryProblems  CategoryProblem[]
  functionTemplates ProblemFunctionTemplate[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  tags Tag[]

  @@index([createdAt])
  @@index([domain, type, hidden, difficulty, createdAt])
  @@index([domain, type, hidden, createdAt])
}

model Tag {
  id   String @id @default(cuid())
  name String @unique
  slug String @unique

  problems Problem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
}

model ProblemTestCase {
  id        String  @id @default(cuid())
  problemId String
  problem   Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)
  input     String
  output    String
  hidden    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([problemId])
}

model ProblemFunctionTemplate {
  id         String @id @default(cuid())
  problemId  String
  languageId Int

  functionTemplate String @db.Text
  driverCode       String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  problem Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)

  @@unique([problemId, languageId])
  @@index([problemId])
}

model Language {
  id       Int    @id @default(autoincrement())
  name     String @unique
  judge0Id Int    @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  submissions Submission[]
}

////////////////////////////////////// Submission Models ////////////////////////////////////////

model Submission {
  id         String @id @default(cuid())
  problemId  String
  userId     String
  languageId Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  code   String
  status SubmissionResult @default(PENDING)
  mode   SubmissionMode   @default(SUBMIT)

  testCases TestCase[]
  memory    Int?
  time      Float?

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id], onDelete: Cascade)
  problem  Problem  @relation(fields: [problemId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([problemId, createdAt])
  @@index([userId, problemId])
  @@index([status])
  @@index([userId, status, mode, problemId])
  @@index([userId, status, createdAt])
}

model TestCase {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  status TestCaseResult @default(PENDING)
  index  Int

  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  submissionId String

  memory Int?
  time   Float?

  judge0TrackingId String? @unique
  errorMessage     String?
  stdout           String?

  @@index([submissionId])
}

////////////////////////////////////// Category Models ////////////////////////////////////////

model Category {
  id          String        @id @default(cuid())
  name        String
  description String?
  slug        String        @unique
  order       Int           @default(0)
  domain      ProblemDomain @default(DSA)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  categoryProblems CategoryProblem[]

  @@index([order])
  @@index([slug])
  @@index([domain, order])
}

model CategoryProblem {
  id         String @id @default(cuid())
  categoryId String
  problemId  String
  order      Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  problem  Problem  @relation(fields: [problemId], references: [id], onDelete: Cascade)

  @@unique([categoryId, problemId])
  @@index([categoryId, order])
  @@index([problemId])
}

////////////////////////////////////// Enums ////////////////////////////////////////////

enum Role {
  ADMIN
  INSTITUTION
  STUDENT
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
  CONCEPT
}

enum ProblemType {
  PRACTICE
  LEARN
}

enum ProblemDomain {
  DSA
  SQL
}

enum SubmissionMode {
  RUN
  SUBMIT
}

enum SubmissionResult {
  PENDING
  ACCEPTED
  WRONG_ANSWER
  TIME_LIMIT_EXCEEDED
  MEMORY_LIMIT_EXCEEDED
  RUNTIME_ERROR
  COMPILE_ERROR
}

enum TestCaseResult {
  PENDING
  ACCEPTED
  WRONG_ANSWER
  TIME_LIMIT_EXCEEDED
  MEMORY_LIMIT_EXCEEDED
  RUNTIME_ERROR
  COMPILE_ERROR
}
