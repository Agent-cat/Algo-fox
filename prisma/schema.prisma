generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String  @id
  name      String
  collageId String?
  email     String  @unique

  totalScore     Int @default(0)
  problemsSolved Int @default(0)

  tags          String[] @default(["student"])
  emailVerified Boolean  @default(false)
  image         String?

  codeChefHandle   String?
  leetCodeHandle   String?
  hackerrankHandle String?
  githubHandle     String?

  role                Role    @default(STUDENT)
  onboardingCompleted Boolean @default(false)
  bio                 String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions    Session[]
  accounts    Account[]
  submissions Submission[]
  // contestPoints      ContestPoint[]
  // contestSubmissions ContestSubmission[]
  problems    Problem[]

  // @@unique([collageId, email]) // Removed as email is unique now
  @@index([collageId])
  @@index([collageId, totalScore]) // leaderboard per college
  @@map("user")
}

model Problem {
  id          String @id @default(cuid())
  title       String
  description String

  hidden     Boolean    @default(true)
  slug       String     @unique
  score      Int
  solved     Int?       @default(0)
  difficulty Difficulty @default(EASY)

  // contestSubmissions ContestSubmission[]
  // contestProblems    ContestProblem[]

  submissions Submission[]
  testCases   ProblemTestCase[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  @@index([hidden, difficulty]) // problem list filtering
  @@index([createdAt])
}

model ProblemTestCase {
  id        String  @id @default(cuid())
  problemId String
  problem   Problem @relation(fields: [problemId], references: [id], onDelete: Cascade)
  input     String
  output    String
  hidden    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([problemId])
}

model Submission {
  id         String @id @default(cuid())
  problemId  String
  userId     String
  languageId Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  code   String
  status SubmissionResult @default(PENDING)
  mode   SubmissionMode   @default(SUBMIT)

  testCases TestCase[]
  memory    Int?
  time      Float?

  // activeContestId    String?
  // activeContest      Contest?            @relation(fields: [activeContestId], references: [id], onDelete: Cascade)

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  // contestSubmissions ContestSubmission[]
  language Language @relation(fields: [languageId], references: [id], onDelete: Cascade)
  problem  Problem  @relation(fields: [problemId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt]) // user submission history
  @@index([problemId, createdAt]) // problem submissions
  @@index([userId, problemId]) // solved check
  @@index([status]) // judge workers
}

model Language {
  id       Int    @id @default(autoincrement())
  name     String @unique
  judge0Id Int    @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  submissions Submission[]
}

model TestCase {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  status TestCaseResult @default(PENDING)
  index  Int

  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  submissionId String

  memory Int?
  time   Float?

  judge0TrackingId String? @unique
  errorMessage     String?

  @@index([submissionId])
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ipAddress String?
  userAgent String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id         String @id
  accountId  String
  providerId String
  userId     String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum Role {
  ADMIN
  INSTITUTION
  STUDENT
}

enum SubmissionMode {
  RUN
  SUBMIT
}

enum SubmissionResult {
  PENDING
  ACCEPTED
  WRONG_ANSWER
  TIME_LIMIT_EXCEEDED
  MEMORY_LIMIT_EXCEEDED
  RUNTIME_ERROR
  COMPILE_ERROR
}

enum TestCaseResult {
  PENDING
  ACCEPTED
  WRONG_ANSWER
  TIME_LIMIT_EXCEEDED
  MEMORY_LIMIT_EXCEEDED
  RUNTIME_ERROR
  COMPILE_ERROR
}
