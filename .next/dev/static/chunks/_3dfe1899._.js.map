{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///home/vishnu/Documents/projects/Algo-fox/actions/user.action.ts"],"sourcesContent":["\"use server\";\n\nimport { UserService } from \"@/core/services/user.service\";\nimport { auth } from \"@/lib/auth\";\nimport { headers } from \"next/headers\";\nimport { prisma } from \"@/lib/prisma\";\nimport { revalidatePath, updateTag, cacheTag, cacheLife } from \"next/cache\";\n\n/**\n * Get user's total score (cached for 5 minutes)\n * Cache is invalidated when user solves a problem via updateTag\n */\n\nexport async function getUserScore(): Promise<number> {\n    \"use cache: private\"; // Must be at top - allows headers() inside\n    cacheLife({ stale: 300, revalidate: 300 }); // 5 minutes\n\n    const session = await auth.api.getSession({\n        headers: await headers()\n    });\n\n    if (!session?.user?.id) {\n        return 0;\n    }\n\n    const userId = session.user.id;\n\n    cacheTag(`user-score-${userId}`, `user-${userId}`);\n\n    return UserService.getUserScore(userId);\n}\n\n/**\n * Recalculate user's total score based on their solved problems\n * This fixes any incorrect scores in the database\n */\nexport async function recalculateUserScore(): Promise<{ success: boolean; newScore: number }> {\n    const session = await auth.api.getSession({\n        headers: await headers()\n    });\n\n    if (!session?.user?.id) {\n        throw new Error(\"Unauthorized\");\n    }\n\n    const userId = session.user.id;\n\n    return UserService.recalculateUserScore(userId);\n}\n\n/**\n * Complete user onboarding process\n * Updates user profile information and marks onboarding as complete\n */\nexport async function completeOnboarding(data: {\n    name?: string;\n    bio?: string;\n    collegeId: string;\n    year?: string;\n    leetCodeHandle?: string;\n    codeChefHandle?: string;\n    hackerrankHandle?: string;\n    githubHandle?: string;\n}): Promise<{ success: boolean; error?: string }> {\n    const session = await auth.api.getSession({\n        headers: await headers()\n    });\n\n    if (!session?.user?.id) {\n        return { success: false, error: \"Unauthorized\" };\n    }\n\n    const userId = session.user.id;\n\n    const res = await UserService.completeOnboarding(userId, data);\n\n    if (res.success) {\n        // Invalidate Redis cache (redundant but good to have here too)\n        try {\n            const redis = (await import(\"@/lib/redis\")).default;\n            await redis.del(`dashboard:stats:${userId}`);\n        } catch (error) {\n            console.error(\"Failed to invalidate dashboard redis cache:\", error);\n        }\n\n        revalidatePath(\"/dashboard\");\n        updateTag(`user-${userId}`);\n        updateTag(`dashboard-${userId}`);\n        updateTag('dashboard-stats');\n    }\n\n    return res;\n}\n\n/**\n * Update user profile information\n */\nexport async function updateUserInfo(data: {\n    name?: string;\n    bio?: string;\n    leetCodeHandle?: string;\n    codeChefHandle?: string;\n    hackerrankHandle?: string;\n    codeforcesHandle?: string;\n    githubHandle?: string;\n}): Promise<{ success: boolean; error?: string }> {\n    const session = await auth.api.getSession({\n        headers: await headers()\n    });\n\n    if (!session?.user?.id) {\n        return { success: false, error: \"Unauthorized\" };\n    }\n\n    const userId = session.user.id;\n\n    try {\n        await prisma.user.update({\n            where: { id: userId },\n            data: {\n                name: data.name,\n                bio: data.bio,\n                leetCodeHandle: data.leetCodeHandle,\n                codeChefHandle: data.codeChefHandle,\n                codeforcesHandle: data.codeforcesHandle,\n                githubHandle: data.githubHandle,\n            }\n        });\n\n        // Invalidate Redis cache\n        try {\n            const redis = (await import(\"@/lib/redis\")).default;\n            await redis.del(`dashboard:stats:${userId}`);\n        } catch (error) {\n            console.error(\"Failed to invalidate dashboard redis cache:\", error);\n        }\n\n        revalidatePath(\"/dashboard\");\n        updateTag(`user-${userId}`);\n        updateTag(`user-score-${userId}`);\n        updateTag(`dashboard-${userId}`);\n        updateTag('dashboard-stats');\n        return { success: true };\n    } catch (error) {\n        console.error(\"Failed to update user info:\", error);\n        return { success: false, error: \"Failed to update profile\" };\n    }\n}\n\n/**\n * Sync user profile and stats\n * Clears all caches related to the user and revalidates dashboard\n */\nexport async function syncUserProfile(): Promise<{ success: boolean; error?: string }> {\n    const session = await auth.api.getSession({\n        headers: await headers()\n    });\n\n    if (!session?.user?.id) {\n        return { success: false, error: \"Unauthorized\" };\n    }\n\n    const userId = session.user.id;\n\n    try {\n        // Invalidate Redis cache\n        try {\n            const redis = (await import(\"@/lib/redis\")).default;\n            await redis.del(`dashboard:stats:${userId}`);\n            await redis.del(`user-score-${userId}`);\n        } catch (error) {\n            console.error(\"Failed to invalidate redis cache during sync:\", error);\n        }\n\n        // Revalidate Next.js cache\n        revalidatePath(\"/dashboard\");\n        updateTag(`user-${userId}`);\n        updateTag(`user-score-${userId}`);\n        updateTag('dashboard-stats');\n\n        return { success: true };\n    } catch (error) {\n        console.error(\"Sync failed:\", error);\n        return { success: false, error: \"Failed to sync profile\" };\n    }\n}\n\n/**\n * Get user settings data (cached)\n */\nexport async function getUserSettings() {\n    \"use cache: private\";\n    cacheLife({ stale: 300, revalidate: 300 });\n\n    const session = await auth.api.getSession({\n        headers: await headers()\n    });\n\n    if (!session?.user?.id) {\n        return null;\n    }\n\n    const userId = session.user.id;\n    cacheTag(`user-${userId}`);\n\n    const user = await prisma.user.findUnique({\n        where: { id: userId },\n        include: {\n            institution: true\n        }\n    });\n\n    if (!user) return null;\n\n    return {\n        id: user.id,\n        name: user.name,\n        email: user.email,\n        image: user.image,\n        bio: user.bio,\n        institutionName: user.institution?.name\n    };\n}\n"],"names":[],"mappings":";;;;;;;IAiGsB,iBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA"}},
    {"offset": {"line": 19, "column": 0}, "map": {"version":3,"sources":["file:///home/vishnu/Documents/projects/Algo-fox/components/settings/PlatformSettings.tsx"],"sourcesContent":["\"use client\";\n\nimport { useForm, UseFormReturn } from \"react-hook-form\";\nimport { useState } from \"react\";\nimport { Loader2, Trash2, Check, Github } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { updateUserInfo } from \"@/actions/user.action\";\nimport Image from \"next/image\";\n\ninterface PlatformSettingsProps {\n    user: {\n        leetCodeHandle?: string | null;\n        codeChefHandle?: string | null;\n        codeforcesHandle?: string | null;\n        githubHandle?: string | null;\n    };\n}\n\ninterface FormData {\n    leetCodeHandle: string;\n    codeChefHandle: string;\n    codeforcesHandle: string;\n    githubHandle: string;\n}\n\ninterface PlatformRowProps {\n    id: keyof FormData;\n    label: string;\n    iconSrc: string | React.ReactNode;\n    placeholder: string;\n    urlPrefix?: string;\n    form: UseFormReturn<FormData>;\n    onSubmit: (platform: keyof FormData) => Promise<void>;\n    handleDisconnect: (platform: keyof FormData) => Promise<void>;\n    isLoading: string | null;\n    initialValue: string;\n}\n\nconst PlatformRow = ({\n    id,\n    label,\n    iconSrc,\n    placeholder,\n    urlPrefix,\n    form,\n    onSubmit,\n    handleDisconnect,\n    isLoading,\n    initialValue\n}: PlatformRowProps) => {\n    const { register, watch } = form;\n    const value = watch(id);\n\n    // Show connected state only if value is saved (matches initial) and not empty\n    const isSaved = value === initialValue && !!value;\n\n    return (\n            <div className=\"flex items-center justify-between p-4 bg-gray-50 dark:bg-[#1a1a1a]/50 rounded-xl border border-gray-100 dark:border-[#262626]\">\n            <div className=\"flex items-center gap-3 w-1/4\">\n                {typeof iconSrc === \"string\" ? (\n                    <Image src={iconSrc} alt={label} width={24} height={24} className=\"rounded-sm object-contain\" />\n                ) : (\n                    iconSrc\n                )}\n                <span className=\"font-medium text-gray-900 dark:text-gray-100\">{label}</span>\n            </div>\n\n            <div className=\"flex-1 flex gap-2\">\n                    <div className=\"flex-1 flex items-center bg-white dark:bg-[#0a0a0a] border border-gray-200 dark:border-[#333] rounded-lg px-3 overflow-hidden\">\n                    {urlPrefix && <span className=\"text-gray-400 text-sm whitespace-nowrap mr-1\">{urlPrefix}</span>}\n                    <input\n                        {...register(id)}\n                        className=\"flex-1 py-2 bg-transparent border-none outline-none text-sm\"\n                        placeholder={placeholder}\n                    />\n                    </div>\n\n                    {isSaved ? (\n                    <>\n                            <div className=\"flex items-center justify-center w-10 h-10 bg-green-100 dark:bg-green-900/20 text-green-600 rounded-lg\">\n                            <Check className=\"w-5 h-5\" />\n                            </div>\n                            <button\n                            onClick={() => handleDisconnect(id)}\n                            className=\"flex items-center justify-center w-10 h-10 border border-gray-200 dark:border-[#333] hover:bg-red-50 dark:hover:bg-red-900/20 hover:text-red-600 hover:border-red-200 dark:hover:border-red-800 rounded-lg transition-colors\"\n                            >\n                            <Trash2 className=\"w-4 h-4\" />\n                            </button>\n                    </>\n                    ) : (\n                        <button\n                        onClick={() => onSubmit(id)}\n                        disabled={isLoading === id}\n                        className=\"px-4 py-2 bg-white dark:bg-[#0a0a0a] border border-gray-200 dark:border-[#333] hover:bg-gray-50 dark:hover:bg-[#1a1a1a] text-sm font-medium rounded-lg transition-colors min-w-[80px]\"\n                    >\n                        {isLoading === id ? <Loader2 className=\"w-4 h-4 animate-spin mx-auto\" /> : \"Submit\"}\n                    </button>\n                    )}\n            </div>\n        </div>\n    );\n};\n\nexport function PlatformSettings({ user }: PlatformSettingsProps) {\n    const [isLoading, setIsLoading] = useState<string | null>(null); // tracks which platform is loading\n\n    const form = useForm<FormData>({\n        defaultValues: {\n            leetCodeHandle: user.leetCodeHandle || \"\",\n            codeChefHandle: user.codeChefHandle || \"\",\n            codeforcesHandle: user.codeforcesHandle || \"\",\n            githubHandle: user.githubHandle || \"\",\n        }\n    });\n\n    const { getValues, setValue, watch } = form;\n\n    const isGithubConnected = !!user.githubHandle || !!watch(\"githubHandle\");\n\n    const onSubmit = async (platform: keyof FormData) => {\n        setIsLoading(platform);\n        const data = getValues();\n\n        try {\n            const updatePayload = {\n                leetCodeHandle: data.leetCodeHandle,\n                codeChefHandle: data.codeChefHandle,\n                codeforcesHandle: data.codeforcesHandle,\n                githubHandle: data.githubHandle,\n            };\n\n            const res = await updateUserInfo(updatePayload);\n            if (res.success) {\n                toast.success(`${platform} handle updated successfully`);\n                form.reset(data);\n            } else {\n                toast.error(res.error || \"Failed to update profile\");\n            }\n        } catch (error) {\n            toast.error(\"Something went wrong\");\n        } finally {\n            setIsLoading(null);\n        }\n    };\n\n    const handleDisconnect = async (platform: keyof FormData) => {\n         setValue(platform, \"\");\n         await onSubmit(platform);\n    };\n\n    return (\n        <div className=\"space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500\">\n            <div>\n                <h1 className=\"text-2xl font-bold font-mono text-gray-900 dark:text-gray-100\">Platforms</h1>\n                <p className=\"text-gray-500 dark:text-gray-400 text-sm mt-1\">\n                    You can update and verify your platform details here.\n                </p>\n            </div>\n\n            <div className=\"space-y-4\">\n                <h2 className=\"text-lg font-medium font-mono text-gray-900 dark:text-gray-100\">Development</h2>\n\n                <div className=\"flex items-center justify-between p-4 bg-gray-50 dark:bg-[#1a1a1a]/50 rounded-xl border border-gray-100 dark:border-[#262626]\">\n                    <div className=\"flex items-center gap-3\">\n                        <Github className=\"w-6 h-6 text-gray-900 dark:text-gray-100\" />\n                        <span className=\"font-medium text-gray-900 dark:text-gray-100\">Github</span>\n                    </div>\n                    {isGithubConnected ? (\n                         <button className=\"px-4 py-2 bg-white dark:bg-[#0a0a0a] border border-gray-200 dark:border-[#333] text-sm font-medium rounded-lg\">\n                            Connected as {watch(\"githubHandle\")}\n                         </button>\n                    ) : (\n                        <button className=\"px-4 py-2 bg-gray-900 text-white dark:bg-white dark:text-gray-900 text-sm font-medium rounded-lg hover:opacity-90 transition-opacity\">\n                            Connect\n                        </button>\n                    )}\n                </div>\n            </div>\n\n            <div className=\"space-y-4\">\n                <h2 className=\"text-lg font-medium font-mono text-gray-900 dark:text-gray-100\">Problem Solving</h2>\n                <div className=\"space-y-3\">\n                    <PlatformRow\n                        id=\"leetCodeHandle\"\n                        label=\"LeetCode\"\n                        iconSrc=\"/handles_logos/leetcode.png\"\n                        placeholder=\"username\"\n                        urlPrefix=\"https://leetcode.com/u/\"\n                        form={form}\n                        onSubmit={onSubmit}\n                        handleDisconnect={handleDisconnect}\n                        isLoading={isLoading}\n                        initialValue={user.leetCodeHandle || \"\"}\n                    />\n                    <PlatformRow\n                        id=\"codeChefHandle\"\n                        label=\"CodeChef\"\n                        iconSrc=\"/handles_logos/codechef.png\"\n                        placeholder=\"username\"\n                        urlPrefix=\"https://www.codechef.com/users/\"\n                        form={form}\n                        onSubmit={onSubmit}\n                        handleDisconnect={handleDisconnect}\n                        isLoading={isLoading}\n                        initialValue={user.codeChefHandle || \"\"}\n                    />\n                    <PlatformRow\n                        id=\"codeforcesHandle\"\n                        label=\"CodeForces\"\n                        iconSrc=\"/handles_logos/codeforces.png\"\n                        placeholder=\"username\"\n                        urlPrefix=\"https://codeforces.com/profile/\"\n                        form={form}\n                        onSubmit={onSubmit}\n                        handleDisconnect={handleDisconnect}\n                        isLoading={isLoading}\n                        initialValue={user.codeforcesHandle || \"\"}\n                    />\n                </div>\n            </div>\n        </div>\n    );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AACA;AACA;AACA;;;AAPA;;;;;;;AAsCA,MAAM,cAAc,CAAC,EACjB,EAAE,EACF,KAAK,EACL,OAAO,EACP,WAAW,EACX,SAAS,EACT,IAAI,EACJ,QAAQ,EACR,gBAAgB,EAChB,SAAS,EACT,YAAY,EACG;IACf,MAAM,EAAE,QAAQ,EAAE,KAAK,EAAE,GAAG;IAC5B,MAAM,QAAQ,MAAM;IAEpB,8EAA8E;IAC9E,MAAM,UAAU,UAAU,gBAAgB,CAAC,CAAC;IAE5C,qBACQ,6LAAC;QAAI,WAAU;;0BACf,6LAAC;gBAAI,WAAU;;oBACV,OAAO,YAAY,yBAChB,6LAAC,2IAAK;wBAAC,KAAK;wBAAS,KAAK;wBAAO,OAAO;wBAAI,QAAQ;wBAAI,WAAU;;;;;mEAElE;kCAEJ,6LAAC;wBAAK,WAAU;kCAAgD;;;;;;;;;;;;0BAGpE,6LAAC;gBAAI,WAAU;;kCACP,6LAAC;wBAAI,WAAU;;4BACd,2BAAa,6LAAC;gCAAK,WAAU;0CAAgD;;;;;;0CAC9E,6LAAC;gCACI,GAAG,SAAS,GAAG;gCAChB,WAAU;gCACV,aAAa;;;;;;;;;;;;oBAIhB,wBACD;;0CACQ,6LAAC;gCAAI,WAAU;0CACf,cAAA,6LAAC,gNAAK;oCAAC,WAAU;;;;;;;;;;;0CAEjB,6LAAC;gCACD,SAAS,IAAM,iBAAiB;gCAChC,WAAU;0CAEV,cAAA,6LAAC,uNAAM;oCAAC,WAAU;;;;;;;;;;;;qDAItB,6LAAC;wBACD,SAAS,IAAM,SAAS;wBACxB,UAAU,cAAc;wBACxB,WAAU;kCAET,cAAc,mBAAK,6LAAC,+NAAO;4BAAC,WAAU;;;;;uEAAoC;;;;;;;;;;;;;;;;;;AAMnG;KA/DM;AAiEC,SAAS,iBAAiB,EAAE,IAAI,EAAyB;;IAC5D,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,yKAAQ,EAAgB,OAAO,mCAAmC;IAEpG,MAAM,OAAO,IAAA,4KAAO,EAAW;QAC3B,eAAe;YACX,gBAAgB,KAAK,cAAc,IAAI;YACvC,gBAAgB,KAAK,cAAc,IAAI;YACvC,kBAAkB,KAAK,gBAAgB,IAAI;YAC3C,cAAc,KAAK,YAAY,IAAI;QACvC;IACJ;IAEA,MAAM,EAAE,SAAS,EAAE,QAAQ,EAAE,KAAK,EAAE,GAAG;IAEvC,MAAM,oBAAoB,CAAC,CAAC,KAAK,YAAY,IAAI,CAAC,CAAC,MAAM;IAEzD,MAAM,WAAW,OAAO;QACpB,aAAa;QACb,MAAM,OAAO;QAEb,IAAI;YACA,MAAM,gBAAgB;gBAClB,gBAAgB,KAAK,cAAc;gBACnC,gBAAgB,KAAK,cAAc;gBACnC,kBAAkB,KAAK,gBAAgB;gBACvC,cAAc,KAAK,YAAY;YACnC;YAEA,MAAM,MAAM,MAAM,IAAA,oKAAc,EAAC;YACjC,IAAI,IAAI,OAAO,EAAE;gBACb,oJAAK,CAAC,OAAO,CAAC,GAAG,SAAS,4BAA4B,CAAC;gBACvD,KAAK,KAAK,CAAC;YACf,OAAO;gBACH,oJAAK,CAAC,KAAK,CAAC,IAAI,KAAK,IAAI;YAC7B;QACJ,EAAE,OAAO,OAAO;YACZ,oJAAK,CAAC,KAAK,CAAC;QAChB,SAAU;YACN,aAAa;QACjB;IACJ;IAEA,MAAM,mBAAmB,OAAO;QAC3B,SAAS,UAAU;QACnB,MAAM,SAAS;IACpB;IAEA,qBACI,6LAAC;QAAI,WAAU;;0BACX,6LAAC;;kCACG,6LAAC;wBAAG,WAAU;kCAAgE;;;;;;kCAC9E,6LAAC;wBAAE,WAAU;kCAAgD;;;;;;;;;;;;0BAKjE,6LAAC;gBAAI,WAAU;;kCACX,6LAAC;wBAAG,WAAU;kCAAiE;;;;;;kCAE/E,6LAAC;wBAAI,WAAU;;0CACX,6LAAC;gCAAI,WAAU;;kDACX,6LAAC,mNAAM;wCAAC,WAAU;;;;;;kDAClB,6LAAC;wCAAK,WAAU;kDAA+C;;;;;;;;;;;;4BAElE,kCACI,6LAAC;gCAAO,WAAU;;oCAAgH;oCACjH,MAAM;;;;;;qDAGxB,6LAAC;gCAAO,WAAU;0CAAuI;;;;;;;;;;;;;;;;;;0BAOrK,6LAAC;gBAAI,WAAU;;kCACX,6LAAC;wBAAG,WAAU;kCAAiE;;;;;;kCAC/E,6LAAC;wBAAI,WAAU;;0CACX,6LAAC;gCACG,IAAG;gCACH,OAAM;gCACN,SAAQ;gCACR,aAAY;gCACZ,WAAU;gCACV,MAAM;gCACN,UAAU;gCACV,kBAAkB;gCAClB,WAAW;gCACX,cAAc,KAAK,cAAc,IAAI;;;;;;0CAEzC,6LAAC;gCACG,IAAG;gCACH,OAAM;gCACN,SAAQ;gCACR,aAAY;gCACZ,WAAU;gCACV,MAAM;gCACN,UAAU;gCACV,kBAAkB;gCAClB,WAAW;gCACX,cAAc,KAAK,cAAc,IAAI;;;;;;0CAEzC,6LAAC;gCACG,IAAG;gCACH,OAAM;gCACN,SAAQ;gCACR,aAAY;gCACZ,WAAU;gCACV,MAAM;gCACN,UAAU;gCACV,kBAAkB;gCAClB,WAAW;gCACX,cAAc,KAAK,gBAAgB,IAAI;;;;;;;;;;;;;;;;;;;;;;;;AAM/D;GAvHgB;;QAGC,4KAAO;;;MAHR"}}]
}