{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///home/vishnu/Documents/projects/Algo-fox/actions/user.action.ts"],"sourcesContent":["\"use server\";\n\nimport { UserService } from \"@/core/services/user.service\";\nimport { auth } from \"@/lib/auth\";\nimport { headers } from \"next/headers\";\nimport { prisma } from \"@/lib/prisma\";\nimport { revalidatePath, updateTag, cacheTag, cacheLife } from \"next/cache\";\n\n/**\n * Get user's total score (cached for 5 minutes)\n * Cache is invalidated when user solves a problem via updateTag\n */\n\nexport async function getUserScore(): Promise<number> {\n    \"use cache: private\"; // Must be at top - allows headers() inside\n    cacheLife({ stale: 300, revalidate: 300 }); // 5 minutes\n\n    const session = await auth.api.getSession({\n        headers: await headers()\n    });\n\n    if (!session?.user?.id) {\n        return 0;\n    }\n\n    const userId = session.user.id;\n\n    cacheTag(`user-score-${userId}`, `user-${userId}`);\n\n    return UserService.getUserScore(userId);\n}\n\n/**\n * Recalculate user's total score based on their solved problems\n * This fixes any incorrect scores in the database\n */\nexport async function recalculateUserScore(): Promise<{ success: boolean; newScore: number }> {\n    const session = await auth.api.getSession({\n        headers: await headers()\n    });\n\n    if (!session?.user?.id) {\n        throw new Error(\"Unauthorized\");\n    }\n\n    const userId = session.user.id;\n\n    return UserService.recalculateUserScore(userId);\n}\n\n/**\n * Complete user onboarding process\n * Updates user profile information and marks onboarding as complete\n */\nexport async function completeOnboarding(data: {\n    name?: string;\n    bio?: string;\n    collegeId: string;\n    year?: string;\n    leetCodeHandle?: string;\n    codeChefHandle?: string;\n    hackerrankHandle?: string;\n    githubHandle?: string;\n}): Promise<{ success: boolean; error?: string }> {\n    const session = await auth.api.getSession({\n        headers: await headers()\n    });\n\n    if (!session?.user?.id) {\n        return { success: false, error: \"Unauthorized\" };\n    }\n\n    const userId = session.user.id;\n\n    const res = await UserService.completeOnboarding(userId, data);\n\n    if (res.success) {\n        // Invalidate Redis cache (redundant but good to have here too)\n        try {\n            const redis = (await import(\"@/lib/redis\")).default;\n            await redis.del(`dashboard:stats:${userId}`);\n        } catch (error) {\n            console.error(\"Failed to invalidate dashboard redis cache:\", error);\n        }\n\n        revalidatePath(\"/dashboard\");\n        updateTag(`user-${userId}`);\n        updateTag(`dashboard-${userId}`);\n        updateTag('dashboard-stats');\n    }\n\n    return res;\n}\n\n/**\n * Update user profile information\n */\nexport async function updateUserInfo(data: {\n    name?: string;\n    bio?: string;\n    leetCodeHandle?: string;\n    codeChefHandle?: string;\n    hackerrankHandle?: string;\n    codeforcesHandle?: string;\n    githubHandle?: string;\n}): Promise<{ success: boolean; error?: string }> {\n    const session = await auth.api.getSession({\n        headers: await headers()\n    });\n\n    if (!session?.user?.id) {\n        return { success: false, error: \"Unauthorized\" };\n    }\n\n    const userId = session.user.id;\n\n    try {\n        await prisma.user.update({\n            where: { id: userId },\n            data: {\n                name: data.name,\n                bio: data.bio,\n                leetCodeHandle: data.leetCodeHandle,\n                codeChefHandle: data.codeChefHandle,\n                codeforcesHandle: data.codeforcesHandle,\n                githubHandle: data.githubHandle,\n            }\n        });\n\n        // Invalidate Redis cache\n        try {\n            const redis = (await import(\"@/lib/redis\")).default;\n            await redis.del(`dashboard:stats:${userId}`);\n        } catch (error) {\n            console.error(\"Failed to invalidate dashboard redis cache:\", error);\n        }\n\n        revalidatePath(\"/dashboard\");\n        updateTag(`user-${userId}`);\n        updateTag(`user-score-${userId}`);\n        updateTag(`dashboard-${userId}`);\n        updateTag('dashboard-stats');\n        return { success: true };\n    } catch (error) {\n        console.error(\"Failed to update user info:\", error);\n        return { success: false, error: \"Failed to update profile\" };\n    }\n}\n\n/**\n * Sync user profile and stats\n * Clears all caches related to the user and revalidates dashboard\n */\nexport async function syncUserProfile(): Promise<{ success: boolean; error?: string }> {\n    const session = await auth.api.getSession({\n        headers: await headers()\n    });\n\n    if (!session?.user?.id) {\n        return { success: false, error: \"Unauthorized\" };\n    }\n\n    const userId = session.user.id;\n\n    try {\n        // Invalidate Redis cache\n        try {\n            const redis = (await import(\"@/lib/redis\")).default;\n            await redis.del(`dashboard:stats:${userId}`);\n            await redis.del(`user-score-${userId}`);\n        } catch (error) {\n            console.error(\"Failed to invalidate redis cache during sync:\", error);\n        }\n\n        // Revalidate Next.js cache\n        revalidatePath(\"/dashboard\");\n        updateTag(`user-${userId}`);\n        updateTag(`user-score-${userId}`);\n        updateTag('dashboard-stats');\n\n        return { success: true };\n    } catch (error) {\n        console.error(\"Sync failed:\", error);\n        return { success: false, error: \"Failed to sync profile\" };\n    }\n}\n\n/**\n * Get user settings data (cached)\n */\nexport async function getUserSettings() {\n    \"use cache: private\";\n    cacheLife({ stale: 300, revalidate: 300 });\n\n    const session = await auth.api.getSession({\n        headers: await headers()\n    });\n\n    if (!session?.user?.id) {\n        return null;\n    }\n\n    const userId = session.user.id;\n    cacheTag(`user-${userId}`);\n\n    const user = await prisma.user.findUnique({\n        where: { id: userId },\n        include: {\n            institution: true\n        }\n    });\n\n    if (!user) return null;\n\n    return {\n        id: user.id,\n        name: user.name,\n        email: user.email,\n        image: user.image,\n        bio: user.bio,\n        institutionName: user.institution?.name\n    };\n}\n"],"names":[],"mappings":";;;;;;;IAiGsB,iBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA"}},
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///home/vishnu/Documents/projects/Algo-fox/components/settings/BasicInfoSettings.tsx"],"sourcesContent":["\"use client\";\n\nimport { useForm } from \"react-hook-form\";\nimport { useState } from \"react\";\nimport { Loader2, Camera, X, Pencil } from \"lucide-react\";\nimport { toast } from \"sonner\";\nimport { updateUserInfo } from \"@/actions/user.action\";\nimport Image from \"next/image\";\n\ninterface BasicInfoSettingsProps {\n    user: {\n        id: string; // needed for key\n        name: string;\n        email: string;\n        image?: string | null;\n        bio?: string | null;\n        institutionName?: string | null;\n    };\n}\n\ninterface FormData {\n    firstName: string; // UI only -> maps to name\n    lastName: string;  // UI only -> maps to name\n    bio: string;\n    // country, school, degree - UI only for now or partial maps\n    school: string;\n}\n\nexport function BasicInfoSettings({ user }: BasicInfoSettingsProps) {\n    const [isLoading, setIsLoading] = useState(false);\n\n    // Naive split for name just for initial value\n    const nameParts = user.name.split(\" \");\n    const initialFirstName = nameParts[0] || \"\";\n    const initialLastName = nameParts.slice(1).join(\" \") || \"\";\n\n    const { register, handleSubmit, formState: { errors } } = useForm<FormData>({\n        defaultValues: {\n            firstName: initialFirstName,\n            lastName: initialLastName,\n            bio: user.bio || \"\",\n            school: user.institutionName || \"\", // Use institution name if available\n        }\n    });\n\n    const onSubmit = async (data: FormData) => {\n        setIsLoading(true);\n        try {\n            // Reconstruct name\n            const fullName = `${data.firstName} ${data.lastName}`.trim();\n\n            const res = await updateUserInfo({\n                name: fullName,\n                bio: data.bio\n                // we aren't updating school/institution here yet as it might need defined structure\n            });\n\n            if (res.success) {\n                toast.success(\"Profile updated successfully\");\n            } else {\n                toast.error(res.error || \"Failed to update profile\");\n            }\n        } catch (error) {\n            toast.error(\"Something went wrong\");\n        } finally {\n            setIsLoading(false);\n        }\n    };\n\n    return (\n        <div className=\"space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500\">\n            <div>\n                <h1 className=\"text-2xl font-bold font-mono text-gray-900 dark:text-gray-100\">Basic Info</h1>\n                <p className=\"text-gray-500 dark:text-gray-400 text-sm mt-1\">\n                    You can manage your details here.\n                </p>\n            </div>\n\n            <div className=\"space-y-6\">\n                <h2 className=\"text-lg font-medium font-mono text-gray-900 dark:text-gray-100\">Basic Details</h2>\n\n                <div className=\"flex items-center gap-6\">\n                    <div className=\"relative group\">\n                         <div className=\"w-24 h-24 rounded-full overflow-hidden border-4 border-white dark:border-[#262626] shadow-lg bg-orange-100 dark:bg-orange-900/20\">\n                            {user.image ? (\n                                <Image\n                                    src={user.image}\n                                    alt={user.name}\n                                    width={96}\n                                    height={96}\n                                    className=\"w-full h-full object-cover\"\n                                />\n                            ) : (\n                                <div className=\"w-full h-full flex items-center justify-center text-3xl font-bold text-orange-600 dark:text-orange-500\">\n                                    {user.name.charAt(0).toUpperCase()}\n                                </div>\n                            )}\n                         </div>\n                         <button className=\"absolute bottom-0 right-0 p-1.5 bg-blue-500 text-white rounded-full shadow-md hover:bg-blue-600 transition-colors border-2 border-white dark:border-[#0a0a0a]\" title=\"Change Picture\">\n                            <Pencil className=\"w-3.5 h-3.5\" />\n                         </button>\n                         <button className=\"absolute bottom-0 left-0 p-1.5 bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full shadow-md hover:bg-red-100 hover:text-red-500 dark:hover:bg-red-900/30 transition-colors border-2 border-white dark:border-[#0a0a0a]\" title=\"Remove Picture\">\n                            <X className=\"w-3.5 h-3.5\" />\n                         </button>\n                    </div>\n                </div>\n\n                <form onSubmit={handleSubmit(onSubmit)} className=\"space-y-6\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                        <div className=\"space-y-2\">\n                             <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300 font-mono\">\n                                First Name <span className=\"text-red-500\">*</span>\n                             </label>\n                             <input\n                                {...register(\"firstName\", { required: \"First name is required\" })}\n                                className=\"w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-[#333] bg-white dark:bg-[#0a0a0a] text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all shadow-sm\"\n                                placeholder=\"First Name\"\n                             />\n                             {errors.firstName && <p className=\"text-xs text-red-500\">{errors.firstName.message}</p>}\n                        </div>\n                        <div className=\"space-y-2\">\n                             <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300 font-mono\">\n                                Last Name\n                             </label>\n                             <input\n                                {...register(\"lastName\")}\n                                className=\"w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-[#333] bg-white dark:bg-[#0a0a0a] text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all shadow-sm\"\n                                placeholder=\"Last Name\"\n                             />\n                        </div>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300 font-mono\">\n                            Email\n                        </label>\n                        <div className=\"w-full px-4 py-2 rounded-lg bg-gray-50 dark:bg-[#1a1a1a] text-gray-500 dark:text-gray-400 border border-gray-200 dark:border-[#333] cursor-not-allowed\">\n                            {user.email}\n                        </div>\n                    </div>\n\n                    <div className=\"space-y-2\">\n                        <label className=\"text-sm font-medium text-gray-700 dark:text-gray-300 font-mono\">\n                            Bio (Max 200 Characters)\n                        </label>\n                        <textarea\n                            {...register(\"bio\")}\n                            rows={4}\n                            className=\"w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-[#333] bg-white dark:bg-[#0a0a0a] text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all shadow-sm resize-none\"\n                            placeholder=\"Tell us about yourself...\"\n                        />\n                    </div>\n\n\n\n                    <div className=\"flex justify-end pt-4\">\n                         <button\n                            type=\"submit\"\n                            disabled={isLoading}\n                            className=\"px-6 py-2.5 bg-orange-600 hover:bg-orange-700 text-white font-medium rounded-lg transition-colors flex items-center gap-2 shadow-lg shadow-orange-500/20 disabled:opacity-70 disabled:cursor-not-allowed\"\n                        >\n                            {isLoading && <Loader2 className=\"w-4 h-4 animate-spin\" />}\n                            Save Changes\n                        </button>\n                    </div>\n                </form>\n            </div>\n        </div>\n    );\n}\n"],"names":[],"mappings":"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"}}]
}