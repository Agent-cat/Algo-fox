{"version":3,"sources":["../../../../actions/courseAllocation.action.ts","../../../../.next-internal/server/app/%28main%29/problems/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["\"use server\";\n\nimport { auth } from \"@/lib/auth\";\nimport { headers } from \"next/headers\";\nimport { prisma } from \"@/lib/prisma\";\nimport { ProblemDomain } from \"@prisma/client\";\nimport { revalidatePath, cacheTag, cacheLife } from \"next/cache\";\n\n// Get all course allocations (cached)\nexport async function getCourseAllocations() {\n  \"use cache\";\n  cacheLife({ stale: 900, revalidate: 900 }); // 15 minutes\n  cacheTag(\"course-allocations\");\n\n  try {\n    const allocations = await prisma.courseAllocation.findMany({\n      orderBy: [{ year: \"asc\" }, { domain: \"asc\" }],\n    });\n    return { success: true, allocations };\n  } catch (error) {\n    console.error(\"Error fetching course allocations:\", error);\n    return { success: false, error: \"Failed to fetch course allocations\" };\n  }\n}\n\n// Get courses allocated to a specific year\nexport async function getCoursesByYear(year: number) {\n  \"use cache\";\n  cacheLife({ stale: 900, revalidate: 900 });\n  cacheTag(\"course-allocations\", `course-year-${year}`);\n\n  try {\n    const allocations = await prisma.courseAllocation.findMany({\n      where: { year },\n      select: { domain: true },\n    });\n    return {\n      success: true,\n      domains: allocations.map((a) => a.domain),\n    };\n  } catch (error) {\n    console.error(\"Error fetching courses by year:\", error);\n    return { success: false, error: \"Failed to fetch courses\", domains: [] as ProblemDomain[] };\n  }\n}\n\n// Get user's allocated courses (based on their year)\nexport async function getUserAllocatedCourses() {\n  \"use cache: private\";\n  cacheLife({ stale: 900, revalidate: 900 });\n\n  const session = await auth.api.getSession({\n    headers: await headers(),\n  });\n\n  if (!session?.user) {\n    return { success: false, error: \"Unauthorized\", domains: [] as ProblemDomain[] };\n  }\n\n  const userId = session.user.id;\n  cacheTag(`user-courses-${userId}`);\n\n  try {\n    // Get user details with year\n    const user = await prisma.user.findUnique({\n      where: { id: userId },\n      select: { year: true, role: true },\n    });\n\n    if (!user) {\n      return { success: false, error: \"User not found\", domains: [] as ProblemDomain[] };\n    }\n\n    // Admins, teachers, institution managers, and contest managers can see all courses\n    const privilegedRoles = [\"ADMIN\", \"TEACHER\", \"INSTITUTION_MANAGER\", \"CONTEST_MANAGER\"];\n    if (privilegedRoles.includes(user.role)) {\n      return {\n        success: true,\n        domains: Object.values(ProblemDomain),\n        isPrivileged: true,\n      };\n    }\n\n    // If student doesn't have a year set, return empty (or all courses based on your preference)\n    if (!user.year) {\n      return {\n        success: true,\n        domains: [] as ProblemDomain[], // No courses until year is set\n        isPrivileged: false,\n      };\n    }\n\n    // Get courses allocated to user's year\n    const allocations = await prisma.courseAllocation.findMany({\n      where: { year: user.year },\n      select: { domain: true },\n    });\n\n    return {\n      success: true,\n      domains: allocations.map((a) => a.domain),\n      isPrivileged: false,\n    };\n  } catch (error) {\n    console.error(\"Error fetching user allocated courses:\", error);\n    return { success: false, error: \"Failed to fetch courses\", domains: [] as ProblemDomain[] };\n  }\n}\n\n// Allocate a course to a year (Admin/Institution Manager only)\nexport async function allocateCourse(year: number, domain: ProblemDomain) {\n  const session = await auth.api.getSession({\n    headers: await headers(),\n  });\n\n  if (!session?.user) {\n    return { success: false, error: \"Unauthorized\" };\n  }\n\n  const userRole = (session.user as any).role;\n  if (![\"ADMIN\", \"INSTITUTION_MANAGER\"].includes(userRole)) {\n    return { success: false, error: \"Insufficient permissions\" };\n  }\n\n  try {\n    await prisma.courseAllocation.create({\n      data: { year, domain },\n    });\n\n    revalidatePath(\"/admin/course-allocation\");\n    revalidatePath(\"/dashboard/institution/course-allocation\");\n    revalidatePath(\"/problems\");\n\n    return { success: true };\n  } catch (error: any) {\n    console.error(\"Error allocating course:\", error);\n    if (error.code === \"P2002\") {\n      return { success: false, error: \"Course already allocated to this year\" };\n    }\n    return { success: false, error: \"Failed to allocate course\" };\n  }\n}\n\n// Remove course allocation (Admin/Institution Manager only)\nexport async function removeCourseAllocation(year: number, domain: ProblemDomain) {\n  const session = await auth.api.getSession({\n    headers: await headers(),\n  });\n\n  if (!session?.user) {\n    return { success: false, error: \"Unauthorized\" };\n  }\n\n  const userRole = (session.user as any).role;\n  if (![\"ADMIN\", \"INSTITUTION_MANAGER\"].includes(userRole)) {\n    return { success: false, error: \"Insufficient permissions\" };\n  }\n\n  try {\n    await prisma.courseAllocation.delete({\n      where: {\n        year_domain: { year, domain },\n      },\n    });\n\n    revalidatePath(\"/admin/course-allocation\");\n    revalidatePath(\"/dashboard/institution/course-allocation\");\n    revalidatePath(\"/problems\");\n\n    return { success: true };\n  } catch (error) {\n    console.error(\"Error removing course allocation:\", error);\n    return { success: false, error: \"Failed to remove allocation\" };\n  }\n}\n\n// Bulk update allocations for a year\nexport async function updateYearAllocations(year: number, domains: ProblemDomain[]) {\n  const session = await auth.api.getSession({\n    headers: await headers(),\n  });\n\n  if (!session?.user) {\n    return { success: false, error: \"Unauthorized\" };\n  }\n\n  const userRole = (session.user as any).role;\n  if (![\"ADMIN\", \"INSTITUTION_MANAGER\"].includes(userRole)) {\n    return { success: false, error: \"Insufficient permissions\" };\n  }\n\n  try {\n    // Delete existing allocations for this year\n    await prisma.courseAllocation.deleteMany({\n      where: { year },\n    });\n\n    // Create new allocations\n    if (domains.length > 0) {\n      await prisma.courseAllocation.createMany({\n        data: domains.map((domain) => ({ year, domain })),\n      });\n    }\n\n    revalidatePath(\"/admin/course-allocation\");\n    revalidatePath(\"/dashboard/institution/course-allocation\");\n    revalidatePath(\"/problems\");\n\n    return { success: true };\n  } catch (error) {\n    console.error(\"Error updating year allocations:\", error);\n    return { success: false, error: \"Failed to update allocations\" };\n  }\n}\n","export {checkSessionConflict as '00f4c838ce10f91796a39f1558a3b75432fa49882a'} from 'ACTIONS_MODULE0'\nexport {resolveSessionConflict as '409bc5870257fe05de038549e85b0722c4e09c83d4'} from 'ACTIONS_MODULE0'\nexport {getUserScore as '80ee7282f708e60661ecc42477a6d2afba42f1d5ed'} from 'ACTIONS_MODULE1'\nexport {getUserAllocatedCourses as '80acc4fbdb1d18310399913f74806d50b70763f4fa'} from 'ACTIONS_MODULE2'\n"],"names":[],"mappings":"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"}