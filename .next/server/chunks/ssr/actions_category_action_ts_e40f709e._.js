module.exports=[394627,a=>{"use strict";var b=a.i(137936),c=a.i(402597),d=a.i(800717),e=a.i(231191),f=a.i(167784);let g=a=>a?`categories:${a}:all`:"categories:all",h=a=>`category:${a}`;class i{static async getCategories(a="DSA",b){try{let c,d=g(a),h=await f.default.get(d);if(h?c=JSON.parse(h).categories:(c=await e.prisma.category.findMany({where:{domain:a},orderBy:{order:"asc"},select:{id:!0,name:!0,description:!0,slug:!0,order:!0,domain:!0,_count:{select:{categoryProblems:!0}}}}),await f.default.setex(d,300,JSON.stringify({categories:c}))),b){let a=await e.prisma.$queryRaw`
           SELECT
             cp."categoryId",
             CAST(COUNT(DISTINCT cp."problemId") AS INTEGER) as "count"
           FROM "CategoryProblem" cp
           JOIN "Submission" s ON cp."problemId" = s."problemId"
           WHERE s."userId" = ${b}
             AND s."status" = 'ACCEPTED'::"SubmissionResult"
             AND s."mode" = 'SUBMIT'::"SubmissionMode"
           GROUP BY cp."categoryId"
         `,d=new Map;a.forEach(a=>{d.set(a.categoryId,a.count)}),c=c.map(a=>({...a,solvedCount:d.get(a.id)||0}))}else c=c.map(a=>({...a,solvedCount:0}));return{categories:c}}catch(a){return console.error("Failed to fetch categories:",a),{categories:[]}}}static async getCategoryBySlug(a){try{let b=h(a),c=await f.default.get(b);if(c)return JSON.parse(c);let d=await e.prisma.category.findUnique({where:{slug:a},include:{_count:{select:{categoryProblems:!0}}}});if(!d)return{success:!1,error:"Category not found"};return await f.default.setex(b,300,JSON.stringify(d)),{success:!0,category:d}}catch(a){return console.error("Failed to fetch category:",a),{success:!1,error:"Failed to fetch category: "+a}}}static async getCategoryById(a){try{let b=await e.prisma.category.findUnique({where:{id:a},include:{_count:{select:{categoryProblems:!0}}}});if(!b)return{success:!1,error:"Category not found"};return{success:!0,category:b}}catch(a){return console.error("Failed to fetch category:",a),{success:!1,error:"Failed to fetch category"}}}static async getCategoryProblems(a,b=1,c=10,d,g){try{let h=g?`category:${a}:problems:cursor:${g}`:`category:${a}:problems:page:${b}`;if(!d||1===b&&!g){let a=await f.default.get(h);if(a){let b=JSON.parse(a);if(d){let a=b.problems.map(a=>a.id),c=await e.prisma.submission.findMany({where:{userId:d,problemId:{in:a},status:"ACCEPTED",mode:"SUBMIT"},select:{problemId:!0},distinct:["problemId"]}),f=new Set(c.map(a=>a.problemId));b.problems=b.problems.map(a=>({...a,isSolved:f.has(a.id)}))}return b}}let[i,j]=await Promise.all([e.prisma.categoryProblem.findMany({where:{categoryId:a},take:c,orderBy:{order:"asc"},skip:g?1:(b-1)*c,...g?{cursor:{id:g}}:{},include:{problem:{include:{_count:{select:{submissions:!0}},...d?{submissions:{where:{userId:d,status:"ACCEPTED",mode:"SUBMIT"},take:1,select:{id:!0}}}:{}}}}}),e.prisma.categoryProblem.count({where:{categoryId:a}})]),k={problems:i.map(a=>{let b=a.problem,c=b.submissions?.length>0;return{...b,isSolved:c,acceptance:b._count.submissions>0?(b.solved||0)/b._count.submissions*100:0,submissions:void 0}}),totalPages:Math.ceil(j/c),currentPage:b,total:j};return d&&(1!==b||g)||await f.default.setex(h,300,JSON.stringify(k)),k}catch(a){return console.error("Failed to fetch category problems:",a),{problems:[],totalPages:0,currentPage:b,total:0}}}static async createCategory(a){try{let b=await e.prisma.category.create({data:{name:a.name,description:a.description,slug:a.slug,order:a.order??0,domain:a.domain||"DSA"}});return await f.default.del(g()),await f.default.del(g(b.domain)),{success:!0,category:b}}catch(a){return console.error("Failed to create category:",a),{success:!1,error:"P2002"===a.code?"Slug already exists":"Failed to create category"}}}static async updateCategory(a,b){try{let c=await e.prisma.category.update({where:{id:a},data:b});return await f.default.del(g()),await f.default.del(h(c.slug)),{success:!0,category:c}}catch(a){return console.error("Failed to update category:",a),{success:!1,error:"Failed to update category"}}}static async deleteCategory(a){try{let b=await e.prisma.category.findUnique({where:{id:a},select:{slug:!0}});return await e.prisma.category.delete({where:{id:a}}),await f.default.del(g()),b&&await f.default.del(h(b.slug)),{success:!0,slug:b?.slug}}catch(a){return console.error("Failed to delete category:",a),{success:!1,error:"Failed to delete category"}}}static async addProblemToCategory(a,b,c){try{let d=await e.prisma.category.findUnique({where:{id:a},select:{domain:!0,slug:!0}});if(!d)return{success:!1,error:"Category not found"};await e.prisma.problem.update({where:{id:b},data:{type:"LEARN",domain:d.domain}});let i=await e.prisma.categoryProblem.create({data:{categoryId:a,problemId:b,order:c??0},include:{problem:!0,category:!0}}),j=`category:${a}:problems:*`,k=await f.default.keys(j);return k.length>0&&await f.default.del(...k),await f.default.del(h(i.category.slug)),await f.default.del(g(d.domain)),{success:!0,categoryProblem:i}}catch(a){if(console.error("Failed to add problem to category:",a),"P2002"===a.code)return{success:!1,error:"Problem already in category"};return{success:!1,error:"Failed to add problem to category"}}}static async removeProblemFromCategory(a,b){try{await e.prisma.categoryProblem.delete({where:{categoryId_problemId:{categoryId:a,problemId:b}}});let c=`category:${a}:problems:*`,d=await f.default.keys(c);return d.length>0&&await f.default.del(...d),{success:!0}}catch(a){return console.error("Failed to remove problem from category:",a),{success:!1,error:"Failed to remove problem from category"}}}static async createProblemAndAddToCategory(a,b){try{let c=await e.prisma.category.findUnique({where:{id:a},select:{domain:!0,slug:!0}});if(!c)return{success:!1,error:"Category not found"};let d=await e.prisma.problem.create({data:{title:b.title,description:b.description,difficulty:b.difficulty,slug:b.slug,score:10*("CONCEPT"!==b.difficulty),hidden:b.hidden,hiddenQuery:b.hiddenQuery||null,type:"LEARN",domain:c.domain,testCases:{create:b.testCases?.map(a=>({input:a.input,output:a.output,hidden:a.hidden??!1}))||[]}}});await e.prisma.categoryProblem.create({data:{categoryId:a,problemId:d.id,order:0}});let i=`category:${a}:problems:*`,j=await f.default.keys(i);j.length>0&&await f.default.del(...j),await f.default.del(h(c.slug)),await f.default.del(g(c.domain));let k=await f.default.keys("problems:*");return k.length>0&&await f.default.del(...k),{success:!0,problem:d}}catch(a){if(console.error("Failed to create problem and add to category:",a),"P2002"===a.code)return{success:!1,error:"Problem slug already exists"};return{success:!1,error:a.message||"Failed to create problem and add to category"}}}}var j=a.i(905246),k=a.i(409223),l=a.i(118558),m=a.i(713095);let n=async function(a="DSA"){(0,l.cacheLife)({stale:900,revalidate:900});let b=await k.auth.api.getSession({headers:await (0,j.headers)()}),c=b?.user?.id;return(0,l.cacheTag)(`categories-${a}${c?`-user-${c}`:""}`,"categories-list"),i.getCategories(a,c)};var o=(0,d.cache)(function(){return(0,c.cache)("private","c0c536a067826bdbc6a9d96fcd0283fe6b4b7d5371",0,n,arguments)});(0,b.registerServerReference)(o,"c0c536a067826bdbc6a9d96fcd0283fe6b4b7d5371",null),Object.defineProperty(o,"name",{value:"getCategories"});let p=async function(a){return(0,l.cacheLife)({stale:900,revalidate:900}),(0,l.cacheTag)(`category-${a}`,"categories-list"),i.getCategoryBySlug(a)};var q=(0,d.cache)(function(){return(0,c.cache)("default","c00481d7c636b3c34d88ef3edfb836b3f52d585ca2",0,p,arguments)});async function r(a){return i.getCategoryById(a)}(0,b.registerServerReference)(q,"c00481d7c636b3c34d88ef3edfb836b3f52d585ca2",null),Object.defineProperty(q,"name",{value:"getCategory"});let s=async function(a,b=1,c=10,d){(0,l.cacheLife)({stale:900,revalidate:900});let e=await k.auth.api.getSession({headers:await (0,j.headers)()}),f=e?.user?.id,g=`category-problems-${a}${d?`-cursor-${d}`:`-page-${b}`}${f?`-user-${f}`:""}`;return(0,l.cacheTag)(g,`category-${a}`,"categories-list"),i.getCategoryProblems(a,b,c,f,d)};var t=(0,d.cache)(function(){return(0,c.cache)("private","f8fbb220165bf0d072e938406b4eb817d99729a202",0,s,arguments)});async function u(a){let b=await k.auth.api.getSession({headers:await (0,j.headers)()});if(!b||"ADMIN"!==b.user.role)throw Error("Unauthorized");let c=await i.createCategory(a);return c.success&&((0,l.revalidatePath)("/problems/dsa"),(0,l.revalidatePath)("/problems/sql"),(0,l.revalidatePath)("/admin/categories"),(0,l.updateTag)("categories-list")),c}async function v(a,b){let c=await k.auth.api.getSession({headers:await (0,j.headers)()});if(!c||"ADMIN"!==c.user.role)throw Error("Unauthorized");let d=await i.updateCategory(a,b);return d.success&&((0,l.revalidatePath)("/problems/dsa"),(0,l.revalidatePath)("/problems/sql"),(0,l.revalidatePath)("/admin/categories"),(0,l.updateTag)("categories-list"),b.slug&&(0,l.updateTag)(`category-${b.slug}`)),d}async function w(a){let b=await k.auth.api.getSession({headers:await (0,j.headers)()});if(!b||"ADMIN"!==b.user.role)throw Error("Unauthorized");let c=await i.deleteCategory(a);return c.success&&((0,l.revalidatePath)("/problems/dsa"),(0,l.revalidatePath)("/problems/sql"),(0,l.revalidatePath)("/admin/categories"),(0,l.updateTag)("categories-list"),c.slug&&(0,l.updateTag)(`category-${c.slug}`)),c}async function x(a,b,c){let d=await k.auth.api.getSession({headers:await (0,j.headers)()});if(!d||"ADMIN"!==d.user.role)throw Error("Unauthorized");let e=await i.addProblemToCategory(a,b,c);return e.success&&((0,l.revalidatePath)("/problems/dsa"),(0,l.revalidatePath)("/problems/sql"),(0,l.revalidatePath)(`/admin/categories/${a}`),(0,l.revalidatePath)(`/admin/dsa/categories/${a}`),(0,l.revalidatePath)(`/admin/sql/categories/${a}`),(0,l.updateTag)(`category-${a}`),(0,l.updateTag)("categories-list")),e}async function y(a,b){let c=await k.auth.api.getSession({headers:await (0,j.headers)()});if(!c||"ADMIN"!==c.user.role)throw Error("Unauthorized");let d=await i.removeProblemFromCategory(a,b);return d.success&&((0,l.revalidatePath)("/problems/dsa"),(0,l.revalidatePath)("/problems/sql"),(0,l.revalidatePath)(`/admin/categories/${a}`)),d}async function z(a,b){let c=await k.auth.api.getSession({headers:await (0,j.headers)()});if(!c||"ADMIN"!==c.user.role)throw Error("Unauthorized");let d=await i.createProblemAndAddToCategory(a,b);return d.success&&((0,l.revalidatePath)("/problems/dsa"),(0,l.revalidatePath)("/problems/sql"),(0,l.revalidatePath)(`/admin/categories/${a}`),(0,l.revalidatePath)(`/admin/dsa/categories/${a}`),(0,l.revalidatePath)(`/admin/sql/categories/${a}`),(0,l.revalidatePath)("/admin/problems"),(0,l.revalidatePath)("/admin/dsa/problems"),(0,l.revalidatePath)("/admin/sql/problems")),d}(0,b.registerServerReference)(t,"f8fbb220165bf0d072e938406b4eb817d99729a202",null),Object.defineProperty(t,"name",{value:"getCategoryProblems"}),(0,m.ensureServerEntryExports)([r,u,v,w,x,y,z]),(0,b.registerServerReference)(r,"4053663bceb8a80c0085656d61a1b89bee3cb8d166",null),(0,b.registerServerReference)(u,"40df636e269e6ad8e68e86a17b941428478fb1279a",null),(0,b.registerServerReference)(v,"6079c58c3044096e2e3c0e124762f766628d945274",null),(0,b.registerServerReference)(w,"4002126267c5e0c1a5eb6b4769d671952c3eb4b33f",null),(0,b.registerServerReference)(x,"706fc56ae5305db762dbcd7da21f654785f49478af",null),(0,b.registerServerReference)(y,"60d2264b1f398652eb46eab2bb3759572857722502",null),(0,b.registerServerReference)(z,"600fce90ff1d93c6a9f08094f28d2d9fce60ec2e62",null),a.s(["$$RSC_SERVER_CACHE_0",()=>o,"$$RSC_SERVER_CACHE_1",()=>q,"$$RSC_SERVER_CACHE_2",()=>t,"addProblemToCategory",()=>x,"createCategory",()=>u,"createProblemAndAddToCategory",()=>z,"deleteCategory",()=>w,"getCategories",()=>o,"getCategory",()=>q,"getCategoryById",()=>r,"getCategoryProblems",()=>t,"removeProblemFromCategory",()=>y,"updateCategory",()=>v],394627)}];

//# sourceMappingURL=actions_category_action_ts_e40f709e._.js.map